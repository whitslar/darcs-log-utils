// Generated by CoffeeScript 1.10.0
(function() {
  var ChildProcess, DarcsLogUtils, Fs, Path, _, moment;

  ChildProcess = require("child_process");

  Path = require("path");

  Fs = require("fs");

  _ = require('underscore');

  moment = require('moment');

  module.exports = DarcsLogUtils = (function() {
    function DarcsLogUtils() {}


    /*
      returns an array of javascript objects representing the commits that effected the requested file
      with line stats, that looks like this:
        [{
          "id": "1c41d8f647f7ad30749edcd0a554bd94e301c651",
          "authorName": "Bee Wilkerson",
          "relativeDate": "6 days ago",
          "authorDate": 1450881433,
          "message": "docs all work again after refactoring to bumble-build",
          "body": "",
          "hash": "1c41d8f",
          "linesAdded": 2,
          "linesDeleted": 2
        }, {
          ...
        }]
     */

    DarcsLogUtils.getCommitHistory = function(fileName) {
      var lastCommitObj, logItems, rawLog;
      logItems = [];
      lastCommitObj = null;
      rawLog = this._fetchFileHistory(fileName);
      console.log(rawLog);
      return this._parseDarcsChanges(rawLog);
    };

    DarcsLogUtils._parseDarcsChanges = function(output) {
      var blankLine, i, lastCommitObject, len, line, logItems, logLines, sign;
      logLines = output.split("\n");
      lastCommitObject = JSON.parse("{}");
      logItems = JSON.parse("[]");
      blankLine = 0;
      logLines.shift();
      logLines.shift();
      for (i = 0, len = logLines.length; i < len; i++) {
        line = logLines[i];
        if (line.split(' ')[0] === 'patch') {
          lastCommitObject.hash = this._sanitize_line(line.split('patch')[1].trim());
        } else if (line.split(' ')[0] === 'Author:') {
          lastCommitObject.authorName = this._sanitize_line(line.split('Author:')[1].trim());
        } else if (line.split(' ')[0] === 'Date:') {
          lastCommitObject.authorDate = moment(line.split('Date:')[1].trim(), "ddd MMM DD HH:mm:ss zz YYYY").unix();
        } else if (line.indexOf('  *') > -1) {
          lastCommitObject.message = this._sanitize_line(line.split('  *')[1].trim());
        } else if ((sign = line.match(/\-|\+/))) {
          if (sign[0] === '-' && line.split('-')[1][0] !== '>') {
            lastCommitObject.linesDeleted = (lastCommitObject.linesDeleted || 0) + Number.parseInt(line.split('-')[1].split(' ')[0]);
            if (line.split('-')[1].match(/\-|\+/)) {
              lastCommitObject.linesAdded = (lastCommitObject.linesAdded || 0) + Number.parseInt(line.split('+')[1]);
            }
          } else if (sign[0] === '+') {
            lastCommitObject.linesAdded = (lastCommitObject.linesAdded || 0) + Number.parseInt(line.split('+')[1]);
          }
        } else if (line === '' || line === '\n' || line === ' ') {
          blankLine = blankLine + 1;
        }
        if (blankLine === 2 && (line === '' || line === '\n' || line === ' ')) {
          logItems.push(lastCommitObject);
          lastCommitObject = JSON.parse("{}");
          blankLine = 0;
        }
      }
      console.log(JSON.stringify(logItems));
      return logItems;
    };

    DarcsLogUtils._fetchFileHistory = function(fileName) {
      var cmd, directory, flags, format, fstats;
      format = ("{\"id\": \"%H\", \"authorName\": \"%an\", \"relativeDate\": \"%cr\", \"authorDate\": %at, " + " \"message\": \"%s\", \"body\": \"%b\", \"hash\": \"%h\"}").replace(/\"/g, "#/dquotes/");
      flags = " --pretty=\"format:" + format + "\" --topo-order --date=local --numstat";
      fstats = Fs.statSync(fileName);
      if (fstats.isDirectory()) {
        directory = fileName;
        fileName = "";
      } else {
        directory = Path.dirname(fileName);
      }
      fileName = Path.normalize(this._escapeSpacesInPath(fileName));
      cmd = "cd /Users/kerismith/salonlofts_com; DARCS_ALWAYS_COLOR=0 DARCS_DO_COLOR_LINES=0 darcs changes --summary " + fileName;
      console.log(cmd);
      if (process.env.DEBUG === '1') {
        console.log('$ ' + cmd);
      }
      return ChildProcess.execSync(cmd, {
        stdio: 'pipe',
        cwd: directory
      }).toString();
    };

    DarcsLogUtils._parseGitLogOutput = function(output) {
      var i, lastCommitObj, lastCommitObject, len, line, logItems, logLines, matches;
      lastCommitObject = null;
      logItems = [];
      logLines = output.split("\n");
      for (i = 0, len = logLines.length; i < len; i++) {
        line = logLines[i];
        if (line[0] === '{' && line[line.length - 1] === '}') {
          lastCommitObj = this._parseCommitObj(line);
          if (lastCommitObj) {
            logItems.push(lastCommitObj);
          }
        } else if (line[0] === '{') {
          lastCommitObj = line;
        } else if (_.isString(lastCommitObj)) {
          lastCommitObj += line;
          if (line[line.length - 1] === '}') {
            lastCommitObj = this._parseCommitObj(lastCommitObj);
            if (lastCommitObj) {
              logItems.push(lastCommitObj);
            }
          }
        } else if ((lastCommitObj != null) && (matches = line.match(/^(\d+)\s*(\d+).*/))) {
          lastCommitObj.linesAdded = (lastCommitObj.linesAdded || 0) + Number.parseInt(matches[1]);
          lastCommitObj.linesDeleted = (lastCommitObj.linesDeleted || 0) + Number.parseInt(matches[2]);
        }
      }
      return logItems;
    };

    DarcsLogUtils._sanitize_line = function(line) {
      var encLine;
      encLine = line.replace(/\t/g, '  ').replace(/\"/g, "'").replace(/(\n|\n\r)/g, '<br>').replace(/\r/g, '<br>').replace(/\#\/dquotes\//g, '"');
      return encLine;
    };

    DarcsLogUtils._parseCommitObj = function(line) {
      var encLine, error;
      encLine = line.replace(/\t/g, '  ').replace(/\"/g, "'").replace(/(\n|\n\r)/g, '<br>').replace(/\r/g, '<br>').replace(/\#\/dquotes\//g, '"');
      try {
        return JSON.parse(encLine);
      } catch (error) {
        console.warn("failed to parse JSON " + encLine);
        return null;
      }
    };


    /*
      See nodejs Path.normalize().  This method extends Path.normalize() to add:
      - escape of space characters
     */

    DarcsLogUtils._escapeSpacesInPath = function(filePath) {
      var spaceReplacement;
      spaceReplacement = process.platform === 'win32' ? '^ ' : '\\ ';
      return filePath.replace(/ /g, spaceReplacement);
    };

    return DarcsLogUtils;

  })();

}).call(this);
